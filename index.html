<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>사용자 데이터 분석 대시보드</title>
    <!-- Vue.js and Chart.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (XLSX) CDN for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
      /* Google Fonts for better typography */
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap");

      :root {
        --primary-color: #42b883;
        --secondary-color: #35495e;
        --background-color: #f4f7f9;
        --container-bg-color: #ffffff;
        --text-color: #333;
        --light-gray-color: #e0e0e0;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
      }

      body {
        font-family: "Noto Sans KR", sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
      }

      #app {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px;
      }

      h1 {
        color: var(--secondary-color);
        font-weight: 700;
        text-align: center;
      }

      h2,
      h3 {
        color: var(--secondary-color);
        margin-top: 0;
        font-weight: 700;
      }

      /* --- Common Container Style --- */
      .dashboard-container {
        background-color: var(--container-bg-color);
        padding: 24px;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px var(--shadow-color);
        width: 100%;
        max-width: 800px;
        max-height: 400px;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
      }

      /* --- File Input Container --- */
      .file-input-container {
        text-align: center;
        max-height: none; /* This container doesn't need a fixed height */
      }

      .upload-btn {
        background-color: var(--primary-color);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background-color 0.3s ease;
      }
      .upload-btn:hover {
        background-color: #36a574;
      }
      .upload-btn input[type="file"] {
        display: none;
      }
      .file-info {
        margin-top: 12px;
        font-size: 14px;
        color: #666;
      }

      /* --- Main Content Area --- */
      .main-content-area {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px;
      }

      /* --- Chart Container --- */
      .chart-container {
        position: relative;
      }

      /* --- Table Container --- */
      .table-scroll-wrapper {
        overflow-y: auto; /* Makes table scrollable within the container */
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th,
      td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--light-gray-color);
      }
      th {
        background-color: #f9fafb;
        font-weight: 500;
        color: var(--secondary-color);
        position: sticky;
        top: 0;
      }
      tbody tr {
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      tbody tr:hover {
        background-color: #f0f0f0;
      }
      tbody tr.selected {
        background-color: #e0f2f1;
      }

      /* --- User Detail Container --- */
      .user-detail-container {
        justify-content: center;
      }

      .user-detail-scroll-wrapper {
        overflow-y: auto;
      }

      .user-detail-placeholder {
        text-align: center;
        color: #888;
      }
      .user-detail-content .detail-item {
        margin-bottom: 12px;
        font-size: 16px;
      }
      .user-detail-content .detail-item strong {
        color: var(--secondary-color);
        display: inline-block;
        width: 100px;
      }
      .user-detail-content .introduction {
        margin-top: 16px;
        padding: 12px;
        background-color: #f8f9fa;
        border-radius: 8px;
        white-space: pre-wrap;
        line-height: 1.6;
      }

      /* --- Export Container --- */
      .export-container {
        max-height: none;
        text-align: center;
      }
      .export-btn {
        background-color: var(--secondary-color);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background-color 0.3s ease;
        margin-top: 16px;
      }
      .export-btn:hover {
        background-color: #2c3e50;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header>
        <h1>사용자 데이터 분석 대시보드</h1>
      </header>

      <!-- 2.1. 파일 입력(File Input) container -->
      <section class="dashboard-container file-input-container">
        <h2>데이터 업로드</h2>
        <p>분석할 사용자 데이터가 담긴 PDF 파일을 업로드하세요.</p>
        <label class="upload-btn">
          파일 첨부
          <input type="file" @change="handleFileUpload" accept=".pdf" />
        </label>
        <div class="file-info" v-if="fileName">
          {{ fileName }} 파일이 준비되었습니다.
        </div>
      </section>

      <!-- 데이터가 로드된 후 표시되는 영역 -->
      <main v-if="users.length > 0" class="main-content-area">
        <!-- 2.2.1. 등급별 인원 현황 (막대 차트) container -->
        <section class="dashboard-container chart-container">
          <h3>등급별 인원 현황</h3>
          <canvas id="gradeChart"></canvas>
        </section>

        <!-- 2.2.2. 전체 유저 정보 (테이블) container -->
        <section class="dashboard-container table-container">
          <h3>전체 유저 정보 ({{ users.length }}명)</h3>
          <div class="table-scroll-wrapper">
            <table>
              <thead>
                <tr>
                  <th>이름</th>
                  <th>등급</th>
                  <th>최종 접속일</th>
                  <th>최종 참여일</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="user in usersWithGrades"
                  :key="user.name"
                  @click="selectUser(user)"
                  :class="{ selected: selectedUser && selectedUser.name === user.name }"
                >
                  <td>{{ user.name }}</td>
                  <td>{{ user.grade.icon }} {{ user.grade.name }}</td>
                  <td>{{ user.lastAccessDate }}</td>
                  <td>{{ user.lastParticipationDate }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- 2.2.4. 유저 상세보기 container -->
        <section class="dashboard-container user-detail-container">
          <h3>유저 상세보기</h3>
          <div class="user-detail-scroll-wrapper">
            <div v-if="selectedUser" class="user-detail-content">
              <div class="detail-item">
                <strong>이름:</strong> {{ selectedUser.name }}
              </div>
              <div class="detail-item">
                <strong>등급:</strong> {{ selectedUser.grade.icon }} {{
                selectedUser.grade.name }}
              </div>
              <div class="detail-item">
                <strong>최종 접속일:</strong> {{ selectedUser.lastAccessDate }}
              </div>
              <div class="detail-item">
                <strong>최종 참여일:</strong> {{
                selectedUser.lastParticipationDate }}
              </div>
              <div class="detail-item">
                <strong>자기소개:</strong>
                <div class="introduction">{{ selectedUser.introduction }}</div>
              </div>
            </div>
            <div v-else class="user-detail-placeholder">
              <p>테이블에서 사용자를 선택하면 상세 정보를 볼 수 있습니다.</p>
            </div>
          </div>
        </section>

        <!-- 2.2.5. export 버튼 -->
        <section class="dashboard-container export-container">
          <h3>데이터 내보내기</h3>
          <p>해당 정보를 다운로드 받으세요</p>
          <button @click="exportToExcel" class="export-btn">
            엑셀 리포트 저장
          </button>
        </section>
      </main>
    </div>

    <script>
      const { createApp, ref, computed, watch, nextTick } = Vue;

      createApp({
        setup() {
          // --- DATA ---
          const users = ref([]);
          const fileName = ref("");
          const selectedUser = ref(null);
          let chartInstance = null;

          const grades = {
            newbie: { name: "신입", icon: "🐥" },
            steady: { name: "꾸준", icon: "📈" },
            enthusiast: { name: "열혈", icon: "🔥" },
            inactive: { name: "미참여", icon: "👻" },
          };

          // --- COMPUTED PROPERTIES ---
          const getUserGrade = (participationCount) => {
            if (participationCount === 0) return grades.inactive;
            if (participationCount <= 3) return grades.newbie;
            if (participationCount < 10) return grades.steady;
            return grades.enthusiast;
          };

          const usersWithGrades = computed(() => {
            return users.value.map((user) => ({
              ...user,
              grade: getUserGrade(user.participationCount),
            }));
          });

          const gradeCounts = computed(() => {
            const counts = { 신입: 0, 꾸준: 0, 열혈: 0, 미참여: 0 };
            usersWithGrades.value.forEach((user) => {
              counts[user.grade.name]++;
            });
            return counts;
          });

          // --- METHODS ---
          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            fileName.value = file.name;
            // NOTE: 실제 PDF 파싱 대신 모의 데이터를 로드합니다.
            loadMockData();
          };

          const loadMockData = () => {
            users.value = [
              {
                name: "김열정",
                participationCount: 15,
                lastAccessDate: "2024.10.25",
                lastParticipationDate: "2024.10.25",
                introduction:
                  "모임의 모든 활동에 참여하는 것을 좋아합니다. 다음 정모가 기대되네요!",
              },
              {
                name: "이꾸준",
                participationCount: 8,
                lastAccessDate: "2024.10.26",
                lastParticipationDate: "2024.10.20",
                introduction: "꾸준히 참여하는 것이 중요하다고 생각합니다.",
              },
              {
                name: "박신입",
                participationCount: 2,
                lastAccessDate: "2024.10.26",
                lastParticipationDate: "2024.10.26",
                introduction:
                  "안녕하세요, 이번에 새로 가입했습니다. 잘 부탁드립니다.",
              },
              {
                name: "최초보",
                participationCount: 1,
                lastAccessDate: "2024.10.24",
                lastParticipationDate: "2024.10.24",
                introduction:
                  "아직은 모든 것이 낯설지만 열심히 배워보겠습니다.",
              },
              {
                name: "정단골",
                participationCount: 7,
                lastAccessDate: "2024.10.21",
                lastParticipationDate: "2024.10.18",
                introduction: "이 모임, 정말 마음에 들어요.",
              },
              {
                name: "강매니아",
                participationCount: 22,
                lastAccessDate: "2024.10.26",
                lastParticipationDate: "2024.10.25",
                introduction: "운영진 버금가는 열정으로 함께합니다.",
              },
              {
                name: "조유령",
                participationCount: 0,
                lastAccessDate: "2024.08.10",
                lastParticipationDate: "N/A",
                introduction: "가입만 하고 활동을 못했네요.",
              },
              {
                name: "윤새내기",
                participationCount: 3,
                lastAccessDate: "2024.10.22",
                lastParticipationDate: "2024.10.22",
                introduction: "만나서 반갑습니다.",
              },
            ];
            selectedUser.value = null; // 데이터 리로드 시 선택 초기화
          };

          const selectUser = (user) => {
            selectedUser.value = user;
          };

          const renderChart = () => {
            if (chartInstance) {
              chartInstance.destroy();
            }
            const ctx = document.getElementById("gradeChart").getContext("2d");
            chartInstance = new Chart(ctx, {
              type: "bar",
              data: {
                labels: Object.keys(gradeCounts.value),
                datasets: [
                  {
                    label: "등급별 인원",
                    data: Object.values(gradeCounts.value),
                    backgroundColor: [
                      "rgba(255, 206, 86, 0.7)",
                      "rgba(54, 162, 235, 0.7)",
                      "rgba(255, 99, 132, 0.7)",
                      "rgba(153, 102, 255, 0.7)",
                    ],
                    borderColor: [
                      "rgba(255, 206, 86, 1)",
                      "rgba(54, 162, 235, 1)",
                      "rgba(255, 99, 132, 1)",
                      "rgba(153, 102, 255, 1)",
                    ],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      stepSize: 1,
                    },
                  },
                },
                plugins: {
                  legend: {
                    display: false,
                  },
                },
              },
            });
          };

          const exportToExcel = () => {
            const dataToExport = usersWithGrades.value.map((user) => ({
              이름: user.name,
              등급: `${user.grade.icon} ${user.grade.name}`,
              "참여 횟수": user.participationCount,
              "최종 접속일": user.lastAccessDate,
              "최종 참여일": user.lastParticipationDate,
              자기소개: user.introduction,
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "사용자 데이터");
            XLSX.writeFile(workbook, "사용자_분석_리포트.xlsx");
          };

          // --- WATCHERS ---
          watch(
            users,
            (newUsers) => {
              if (newUsers.length > 0) {
                nextTick(() => {
                  renderChart();
                });
              }
            },
            { deep: true }
          );

          return {
            users,
            fileName,
            selectedUser,
            usersWithGrades,
            handleFileUpload,
            selectUser,
            exportToExcel,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
